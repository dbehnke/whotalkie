<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhoTalkie PTT Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .status {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            gap: 20px;
        }
        .status-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex: 1;
        }
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .status-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .ptt-controls {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            background: #fafafa;
        }
        .channels-section, .users-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .channels-panel, .users-panel {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .panel-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .channel-list, .user-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .channel-item, .user-item {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .channel-item:hover {
            background: #e3f2fd;
        }
        .channel-item.active {
            background: #2196F3;
            color: white;
        }
        .user-item.active {
            background: #4CAF50;
            color: white;
        }
        .user-item.talking {
            background: #FF9800;
            color: white;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .ptt-button {
            width: 100%;
            height: 80px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin: 10px 0;
        }
        .ptt-button:hover {
            background: #45a049;
        }
        .ptt-button:active, .ptt-button.active {
            background: #FF5722;
            transform: scale(0.98);
        }
        .ptt-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .connection-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336;
        }
        .status-indicator.connected {
            background: #4CAF50;
        }
        #messages {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .channel-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .join-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .join-button:hover {
            background: #1976D2;
        }
        .leave-button {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        .leave-button:hover {
            background: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>WhoTalkie PTT Dashboard</h1>
            <p>Push-to-Talk Communication Server</p>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="status-value" id="server-status">Online</div>
                <div class="status-label">Server Status</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="active-channels">0</div>
                <div class="status-label">Active Channels</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="connected-users">0</div>
                <div class="status-label">Connected Users</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="total-clients">0</div>
                <div class="status-label">Total Clients</div>
            </div>
        </div>

        <div class="ptt-controls">
            <div class="connection-info">
                <div class="status-indicator" id="connection-status"></div>
                <span id="connection-text">Disconnected</span>
                <span id="user-info"></span>
            </div>
            
            <div>
                <input type="text" id="channel-input" class="channel-input" placeholder="Enter channel name (e.g., 'general', 'team1')" />
                <button onclick="joinChannel()" class="join-button">Join Channel</button>
                <button onclick="leaveChannel()" class="leave-button">Leave Channel</button>
            </div>
            
            <button id="ptt-button" class="ptt-button" disabled 
                    onmousedown="startPTT()" onmouseup="endPTT()" 
                    ontouchstart="startPTT()" ontouchend="endPTT()">
                HOLD TO TALK
            </button>
            <div style="text-align: center; font-size: 12px; color: #666;">
                Hold the button down to transmit. Release to stop.
            </div>
        </div>

        <div class="channels-section">
            <div class="channels-panel">
                <div class="panel-title">Active Channels</div>
                <div id="channels-list" class="channel-list">
                    <div style="color: #999; text-align: center; padding: 20px;">No active channels</div>
                </div>
            </div>
            <div class="users-panel">
                <div class="panel-title">Connected Users</div>
                <div id="users-list" class="user-list">
                    <div style="color: #999; text-align: center; padding: 20px;">No connected users</div>
                </div>
            </div>
        </div>

        <div class="ptt-controls">
            <h3>Activity Log</h3>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentUser = null;
        let currentChannel = '';
        let isPTTActive = false;
        
        const messagesDiv = document.getElementById('messages');
        const connectionStatus = document.getElementById('connection-status');
        const connectionText = document.getElementById('connection-text');
        const userInfo = document.getElementById('user-info');
        const pttButton = document.getElementById('ptt-button');

        function connect() {
            if (ws) return;
            
            ws = new WebSocket('ws://localhost:8080/ws');
            
            ws.onopen = function() {
                connectionStatus.classList.add('connected');
                connectionText.textContent = 'Connected';
                addMessage('Connected to server');
                updateStats();
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleServerEvent(data);
                } catch (e) {
                    addMessage('Received: ' + event.data);
                }
            };
            
            ws.onclose = function() {
                connectionStatus.classList.remove('connected');
                connectionText.textContent = 'Disconnected';
                userInfo.textContent = '';
                addMessage('Disconnected from server');
                pttButton.disabled = true;
                ws = null;
                
                // Try to reconnect after 3 seconds
                setTimeout(connect, 3000);
            };
            
            ws.onerror = function(error) {
                addMessage('Connection error: ' + error);
            };
        }

        function handleServerEvent(event) {
            addMessage(`Event: ${event.type} from ${event.user_id} ${event.data ? '- ' + JSON.stringify(event.data) : ''}`);
            
            switch (event.type) {
                case 'user_join':
                    if (event.user_id && event.data && event.data.username) {
                        if (!currentUser && ws && ws.readyState === WebSocket.OPEN) {
                            // This might be us
                            const parts = event.user_id.split('-');
                            if (parts.length > 0) {
                                currentUser = {
                                    id: event.user_id,
                                    username: event.data.username
                                };
                                userInfo.textContent = ` - ${event.data.username}`;
                                pttButton.disabled = false;
                            }
                        }
                    }
                    updateStats();
                    updateUsersList();
                    break;
                    
                case 'user_leave':
                    updateStats();
                    updateUsersList();
                    break;
                    
                case 'channel_join':
                    if (event.user_id === (currentUser ? currentUser.id : '')) {
                        currentChannel = event.channel_id;
                        document.getElementById('channel-input').value = currentChannel;
                    }
                    updateStats();
                    updateChannelsList();
                    updateUsersList();
                    break;
                    
                case 'channel_leave':
                    if (event.user_id === (currentUser ? currentUser.id : '')) {
                        currentChannel = '';
                        document.getElementById('channel-input').value = '';
                    }
                    updateStats();
                    updateChannelsList();
                    updateUsersList();
                    break;
                    
                case 'ptt_start':
                    addMessage(`🎙️ ${event.data.username} started talking in ${event.channel_id}`);
                    highlightTalkingUser(event.user_id, true);
                    break;
                    
                case 'ptt_end':
                    addMessage(`🔇 ${event.data.username} stopped talking in ${event.channel_id}`);
                    highlightTalkingUser(event.user_id, false);
                    break;
                    
                case 'heartbeat':
                    // Silent heartbeat response
                    break;
            }
        }

        function sendEvent(eventType, data = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const event = {
                    type: eventType,
                    channel_id: currentChannel,
                    timestamp: new Date().toISOString(),
                    data: data
                };
                ws.send(JSON.stringify(event));
            }
        }

        function joinChannel() {
            const channelName = document.getElementById('channel-input').value.trim();
            if (!channelName) {
                alert('Please enter a channel name');
                return;
            }
            
            sendEvent('channel_join', { channel_name: channelName });
        }

        function leaveChannel() {
            if (currentChannel) {
                sendEvent('channel_leave');
            }
        }

        function startPTT() {
            if (!currentChannel || isPTTActive) return;
            
            isPTTActive = true;
            pttButton.classList.add('active');
            pttButton.textContent = 'TRANSMITTING...';
            sendEvent('ptt_start');
        }

        function endPTT() {
            if (!isPTTActive) return;
            
            isPTTActive = false;
            pttButton.classList.remove('active');
            pttButton.textContent = 'HOLD TO TALK';
            sendEvent('ptt_end');
        }

        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(stats => {
                    document.getElementById('active-channels').textContent = stats.active_channels;
                    document.getElementById('connected-users').textContent = stats.active_users;
                    document.getElementById('total-clients').textContent = stats.connected_clients;
                })
                .catch(err => console.error('Failed to fetch stats:', err));
        }

        function updateChannelsList() {
            fetch('/api/channels')
                .then(response => response.json())
                .then(data => {
                    const channelsList = document.getElementById('channels-list');
                    if (data.channels && data.channels.length > 0) {
                        channelsList.innerHTML = data.channels.map(channel => 
                            `<div class="channel-item ${channel.id === currentChannel ? 'active' : ''}" onclick="selectChannel('${channel.id}')">
                                ${channel.name} (${channel.users.length} users)
                            </div>`
                        ).join('');
                    } else {
                        channelsList.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No active channels</div>';
                    }
                })
                .catch(err => console.error('Failed to fetch channels:', err));
        }

        function updateUsersList() {
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    const usersList = document.getElementById('users-list');
                    if (data.users && data.users.length > 0) {
                        usersList.innerHTML = data.users.map(user => 
                            `<div class="user-item ${user.is_active ? 'active' : ''}" id="user-${user.id}">
                                ${user.username}${user.channel ? ` (${user.channel})` : ''}
                            </div>`
                        ).join('');
                    } else {
                        usersList.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No connected users</div>';
                    }
                })
                .catch(err => console.error('Failed to fetch users:', err));
        }

        function selectChannel(channelId) {
            document.getElementById('channel-input').value = channelId;
            joinChannel();
        }

        function highlightTalkingUser(userId, isTalking) {
            const userElement = document.getElementById(`user-${userId}`);
            if (userElement) {
                if (isTalking) {
                    userElement.classList.add('talking');
                } else {
                    userElement.classList.remove('talking');
                }
            }
        }

        function addMessage(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && !e.repeat) {
                e.preventDefault();
                startPTT();
            }
        });

        document.addEventListener('keyup', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                endPTT();
            }
        });

        // Prevent space from scrolling page when used for PTT
        window.addEventListener('keydown', function(e) {
            if(e.keyCode === 32 && e.target === document.body) {
                e.preventDefault();
            }
        });

        // Auto-connect and periodic updates
        window.onload = function() {
            connect();
            setInterval(updateStats, 2000);
            setInterval(updateChannelsList, 3000);
            setInterval(updateUsersList, 3000);
        };
    </script>
</body>
</html>